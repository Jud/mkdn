<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { background: transparent; width: 100%; }
        body { overflow: visible; }
        #diagram { display: block; width: 100%; }
        #diagram svg { display: block; width: 100%; height: auto; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(128, 128, 128, 0.3); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(128, 128, 128, 0.5); }
        ::-webkit-scrollbar-corner { background: transparent; }
        foreignObject div { overflow: hidden !important; }
    </style>
    <script src="mermaid.min.js"></script>
</head>
<body>
    <div id="diagram">
        <pre class="mermaid">__MERMAID_CODE__</pre>
    </div>
    <script>
        var originalCode = `__MERMAID_CODE_JS__`;

        if (typeof mermaid === 'undefined') {
            window.webkit.messageHandlers.renderError.postMessage({
                message: 'mermaid.min.js failed to load. Check that the resource is bundled correctly.'
            });
        } else {
            mermaid.initialize({
                startOnLoad: false,
                theme: 'base',
                themeVariables: __THEME_VARIABLES__,
                securityLevel: 'strict',
                flowchart: { htmlLabels: true },
            });

            var resizeObserver = null;
            var resizeRAF = null;

            function sendSizeReport() {
                var svg = document.querySelector('#diagram svg');
                if (svg) {
                    var bbox = svg.getBoundingClientRect();
                    if (bbox.width > 0) {
                        window.webkit.messageHandlers.sizeReport.postMessage({
                            width: bbox.width,
                            height: bbox.height
                        });
                    }
                }
            }

            function installResizeObserver() {
                if (resizeObserver) resizeObserver.disconnect();
                var target = document.querySelector('#diagram svg') || document.getElementById('diagram');
                if (!target) return;
                resizeObserver = new ResizeObserver(function() {
                    if (resizeRAF) cancelAnimationFrame(resizeRAF);
                    resizeRAF = requestAnimationFrame(function() {
                        resizeRAF = null;
                        sendSizeReport();
                    });
                });
                resizeObserver.observe(target);
            }

            async function render() {
                try {
                    await mermaid.run({ querySelector: '.mermaid' });
                    var svg = document.querySelector('#diagram svg');
                    if (svg) {
                        sendSizeReport();
                        installResizeObserver();
                        window.webkit.messageHandlers.renderComplete.postMessage({});
                    } else {
                        window.webkit.messageHandlers.renderError.postMessage({
                            message: 'Mermaid.run() completed but no SVG element was produced.'
                        });
                    }
                } catch (error) {
                    window.webkit.messageHandlers.renderError.postMessage({
                        message: error.message || String(error)
                    });
                }
            }

            window.reRenderWithTheme = function(themeVarsJSON) {
                mermaid.initialize({
                    startOnLoad: false,
                    theme: 'base',
                    themeVariables: themeVarsJSON,
                    securityLevel: 'strict',
                    flowchart: { htmlLabels: true },
                });
                var container = document.getElementById('diagram');
                var svg = container.querySelector('svg');
                if (svg) svg.remove();
                var pre = document.createElement('pre');
                pre.className = 'mermaid';
                pre.textContent = originalCode;
                container.appendChild(pre);
                render();
            };

            render();
        }
    </script>
</body>
</html>
