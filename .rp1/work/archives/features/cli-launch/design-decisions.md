# Design Decisions: CLI Launch

**Feature ID**: cli-launch
**Created**: 2026-02-06

## Decision Log

| ID | Decision | Choice | Rationale | Alternatives Considered |
|----|----------|--------|-----------|------------------------|
| D1 | Entry point architecture | Top-level code in main.swift with explicit MkdnApp.main() call | Allows intercepting CLI arguments before SwiftUI lifecycle starts, which is the only reliable way to prevent a GUI window from appearing on error (FR-8). The MkdnApp struct stays in mkdnEntry/main.swift but drops @main. | (a) Parse in App.init and call exit() -- risky because SwiftUI may have already created window infrastructure by the time init runs. (b) NSApplicationDelegate approach -- heavier refactor, breaks the existing SwiftUI App pattern. |
| D2 | Argument parser library | swift-argument-parser (existing dependency) | Already declared in Package.swift and linked to mkdnLib. Provides automatic --help/--version generation, typed argument parsing, and proper error formatting to stderr. Industry standard for Swift CLIs. | (a) Manual CommandLine.arguments parsing -- error-prone, no --help generation, re-invents the wheel. (b) Other CLI frameworks -- unnecessary dependency churn when ArgumentParser is already present. |
| D3 | CLI-to-App state communication | LaunchContext enum with static nonisolated(unsafe) property | Simplest correct mechanism for the access pattern: written once in top-level code before MkdnApp.main(), read once during MkdnApp.init(). Strictly sequential -- no concurrency. The nonisolated(unsafe) annotation satisfies Swift 6 strict concurrency for static mutable state with a known-safe access pattern. | (a) Environment variable -- stringly typed, requires parsing, fragile. (b) UserDefaults -- introduces persistent side effects for transient launch state. (c) Global actor-isolated property -- unnecessary overhead for a sequential set-read pattern. |
| D4 | File validation order | Extension check -> existence check -> readability check | Follows BR-2 from requirements. Extension check is a string comparison (cheapest), existence is a filesystem stat, readability requires a file read (most expensive). Checking in cost order avoids unnecessary filesystem access. Also produces the most specific error for each failure case. | (a) Existence before extension -- wastes a filesystem call for files that would be rejected by extension anyway (e.g., file.txt that exists). |
| D5 | Error type design | CLIError enum conforming to LocalizedError | Follows the established project pattern (MermaidError). Typed cases enable: (1) structured exit code mapping per error type, (2) consistent error message formatting, (3) testable error properties. | (a) Bare strings -- no type safety, no exit code mapping, not testable. (b) NSError codes -- not idiomatic Swift 6. |
| D6 | File loading timing | AppState.loadFile(at:) called in MkdnApp.init | Pre-populates AppState before the first SwiftUI render pass. This avoids a visible flash where WelcomeView appears for one frame before the file content loads. The file has already been fully validated (existence + readability) by FileValidator, so loadFile failure is extremely unlikely. A defensive try? ensures graceful degradation to WelcomeView if something unexpected happens. | (a) .task modifier on ContentView -- async, causes visible WelcomeView flash before file content appears. (b) .onAppear -- same flash issue. Both alternatives degrade the perceived launch performance (SM-1: under 1 second). |
| D7 | Old CLIHandler disposition | Delete CLIHandler.swift and CLIHandlerTests.swift | The new MkdnCLI + FileValidator system fully replaces CLIHandler. The old code is not referenced from any path in the codebase. Keeping dead code creates maintenance confusion and violates the principle of a clean codebase. | (a) Deprecate and keep -- adds noise, no consumer needs it. |
| D8 | Version string source | Hardcoded string in MkdnCLI CommandConfiguration | Simple, explicit, and correct for the current project stage. SPM CLI executables do not have an Info.plist by default, so bundle version extraction is not available. A hardcoded version is easy to update and easy to find. | (a) Info.plist bundle version -- not available in SPM CLI executables without custom build plugins. (b) Git describe at build time -- adds build script complexity for marginal benefit at this stage. |

## AFK Mode: Auto-Selected Technology Decisions

| Decision | Choice | Source | Rationale |
|----------|--------|--------|-----------|
| Argument parsing library | swift-argument-parser | KB modules.md, Package.swift | Already declared as a dependency and linked to mkdnLib. Requirements explicitly name it. No decision needed. |
| Path resolution APIs | Foundation (NSString.expandingTildeInPath, URL, FileManager) | Existing CLIHandler.swift pattern | Current codebase already uses these exact APIs for path resolution. Consistent with established patterns. |
| Error handling pattern | Typed enum with LocalizedError | KB patterns.md (Error Handling section) | Project pattern uses typed errors with LocalizedError conformance (see MermaidError). |
| Testing framework | Swift Testing (@Suite, @Test, #expect) | KB patterns.md (Testing Pattern section) | Project standard. All existing tests use Swift Testing. |
| Static state pattern | nonisolated(unsafe) static var | MEMORY.md (Swift 6 patterns) | Project has established pattern for static mutable properties that are safe by construction. |
| MkdnApp location | Defined in mkdnEntry/main.swift (not moved to mkdnLib) | Existing two-target layout | Maintains the established pattern where the App definition lives in the executable target. Moving it to mkdnLib would require removing the exclude and testing App lifecycle, which is out of scope. |
