# Design Decisions: Automated UI Testing -- End-to-End Validation

**Feature ID**: automated-ui-testing
**Created**: 2026-02-08

## Decision Log

| ID | Decision | Choice | Rationale | Alternatives Considered |
|----|----------|--------|-----------|------------------------|
| D1 | Suite execution order | Sequential: spatial -> visual -> animation | Risk-based ordering per CL-003. Spatial is simplest (single static capture), animation is highest risk (SCStream frame capture). Infrastructure fixes discovered in earlier suites benefit later ones. | Parallel execution (faster but harder to diagnose), reverse order (riskiest first to fail fast) |
| D2 | Pre-migration gap handling | Document and optionally adjust test expectations with migration comments | Per BR-002 and CL-001. The goal is infrastructure validation, not pre-migration compliance enforcement. Adjusting expectations allows the suite to serve as a green baseline. | Leave tests failing (clutters results, harder to spot real regressions), fix rendering code (out of scope) |
| D3 | Tolerance adjustment policy | Only in response to empirical failure, justified by measured variance | Per BR-005. Starting with configured tolerances (1pt spatial, 10/15/25 color, 1-frame animation). Widening requires documenting observed variance across multiple measurements. | Proactive loosening (risks masking real issues), keeping tight and accepting flakiness (undermines agent confidence) |
| D4 | Determinism target | 3 consecutive runs (reduced from 10) | Per CL-002. Priority is validating infrastructure works at all. 3 runs catches obvious flakiness while keeping iteration time reasonable (~15 min total for 3 runs). | 10 runs (prior iteration target, too time-consuming for this iteration), 1 run (insufficient for flakiness detection) |
| D5 | Console output for diagnosis | Redirect stderr to pipe during smoke test, nullDevice for suite runs | AppLauncher sets stdout/stderr to nullDevice. For smoke test diagnosis, temporarily capture stderr to see harness server logs. For suite runs, rely on JSON report and captured images. | Always capture (noise in test output), never capture (blind to server-side errors) |
| D6 | Build strategy | Pre-build once, all suites use buildFirst:false | Existing pattern in all three harness singletons. Build happens once as T1 prerequisite. Avoids 30-60s build overhead per suite. | Build per suite (wastes time), modify harness to share one app instance (architectural change, out of scope per BR-003) |
| D7 | Fix scope boundary | Infrastructure fixes only; no rendering code changes | Per 4.2 Out of Scope and BR-003. This iteration validates infrastructure, not rendering correctness. Rendering issues discovered are documented for future features. | Fix rendering bugs inline (scope creep), ignore rendering issues (loses diagnostic value) |
| D8 | Flaky test resolution | Fix if minimal, document with mitigation if complex | Per AC-010c. Simple fixes (tolerance widening, timing adjustment) are applied. Complex non-determinism (e.g., macOS compositor timing) is documented with a mitigation plan for future work. | Fix all (may require architectural changes), ignore all (undermines test reliability) |
| D9 | SCStream warmup handling | Accept first-run frame delivery characteristics, adjust analysis to handle startup latency | ScreenCaptureKit SCStream has documented startup latency where the first few frames may arrive late or be blank. Rather than architectural changes, the frame analysis algorithms should tolerate this by checking for valid content in initial frames. | Add warmup capture before every animation test (increases test duration), redesign frame capture to detect readiness (architectural change) |
| D10 | Cross-suite process isolation | Maintain separate app instances per suite via existing harness singletons | Each suite (SpatialHarness, VisualHarness, AnimationHarness) manages its own AppLauncher. Socket paths are unique per PID. No shared state between suites. This isolation prevents one suite's state from affecting another. | Share one app instance across suites (requires architectural change to coordinate lifecycle), launch all suites in one process (breaks serialization guarantees) |
