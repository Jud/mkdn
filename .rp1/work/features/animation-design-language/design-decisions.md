# Design Decisions: Animation Design Language

**Feature ID**: animation-design-language
**Created**: 2026-02-07

## Decision Log

| ID | Decision | Choice | Rationale | Alternatives Considered |
|----|----------|--------|-----------|------------------------|
| D1 | Reduce Motion architecture | Central `MotionPreference` struct read from `@Environment(\.accessibilityReduceMotion)` | Single source of truth for animation resolution. Views call `motion.resolved(.springSettle)` instead of scattering `if reduceMotion` conditionals. Keeps Reduce Motion logic testable and centralized. | Per-view conditional checks (scattered, error-prone, hard to audit); Global `@Observable` state object (over-engineered for a read-only system preference that SwiftUI already provides via environment). |
| D2 | Orb visual deduplication | Extract shared 3-layer orb visual into reusable `OrbVisual` component | `FileChangeOrbView` and `DefaultHandlerHintView` have identical ~40-line visual implementations (outerHalo, midGlow, innerCore). Extracting to `OrbVisual` reduces duplication and makes it trivial to apply hover feedback, Reduce Motion, or future visual changes in one place. | Leave duplicated (lower risk of change but doubles maintenance burden for every animation change). |
| D3 | Theme crossfade isolation strategy | Explicit `withAnimation(AnimationConstants.crossfade)` scoping at theme change call sites | SwiftUI's `withAnimation` captures only state changes made within its closure. Wrapping `appSettings.themeMode = newMode` in `withAnimation` ensures only theme-dependent properties animate, while orb pulse/bloom state variables (driven by their own separate `withAnimation` calls) remain unaffected. | Broad `.animation(.crossfade, value: appSettings.theme)` on root view (risks capturing unrelated state changes on the same render pass); `Transaction`-based animation scoping (more complex, less idiomatic SwiftUI). |
| D4 | Popover entrance animation approach | Internal content animation within system `.popover()` modifier | System `.popover()` provides native behavior: arrow positioning, automatic edge avoidance, VoiceOver integration, Escape key dismiss. Custom spring-settle is applied to the popover's *content* via `.onAppear` + `withAnimation(springSettle)` on internal scale/opacity state. This preserves all system behavior while adding the design language's spring feel. | Replace `.popover()` with custom overlay (full animation control but loses system popover arrow, auto-repositioning, and accessibility integration); Accept system default animation (misses the design language's goal of consistent spring entrances). |
| D5 | Staggered content load implementation | Per-block `@State` dictionary with index-based delayed animation | Each block's space is reserved in the layout (opacity 0, offset 8pt) so no layout shifts occur during the stagger. After `renderedBlocks` is set, a single state change marks all blocks as "appeared," and SwiftUI's per-block `.animation(.fadeIn.delay(...))` handles the stagger. On reload, the dictionary is reset to replay. With Reduce Motion, stagger delay is 0, making all blocks appear instantly. | Timer-based progressive insertion (causes layout shifts as blocks are added to the array); Scroll-into-view animation (explicitly out of scope per CL-001). |
| D6 | Hover feedback implementation | Reusable `ViewModifier` with `.onHover` and `quickSettle` spring | Encapsulates hover state, animation, and Reduce Motion logic in one place. Applied via `.hoverScale()` (orbs, toolbar) and `.hoverBrightness()` (Mermaid diagrams). Consistent with SwiftUI ViewModifier pattern already used in the codebase. | Inline `.onHover` in each view (duplicated hover state and animation logic across 5+ views); Custom NSTrackingArea (drops down from SwiftUI layer unnecessarily). |
| D7 | AnimationConstants structure | Keep existing `enum` with static properties; add primitive grouping via MARK comments and documentation | Matches the existing `AnimationConstants` pattern exactly. No architectural change required. Legacy property names preserved as deprecated computed aliases for backward compatibility during migration. | Separate types per primitive group (e.g., `SpringPrimitives`, `FadePrimitives` -- over-engineered for ~30 static constants); Protocol-based abstraction (unnecessary indirection for compile-time constants). |
| D8 | Pulsing Mermaid loading spinner | Custom `PulsingSpinner` view using the `breathe` animation primitive | Visually connects the Mermaid loading state to the orb's breathing rhythm, creating the "kinship" specified in REQ-008. Implementation is a single `Circle` with opacity/scale animation -- minimal GPU cost. | Animated `ProgressView` (no control over pulse rhythm; system spinner has its own timing); Replace with Lottie animation (external dependency explicitly prohibited by constraints). |

## AFK Mode: Auto-Selected Technology Decisions

| Decision | Choice | Source | Rationale |
|----------|--------|--------|-----------|
| Animation framework | SwiftUI Animation API (no additions) | KB patterns.md, requirements constraints | Requirements explicitly prohibit external animation libraries. Existing codebase uses SwiftUI animations exclusively. |
| Reduce Motion detection | `@Environment(\.accessibilityReduceMotion)` | macOS platform API | Standard SwiftUI environment value. Reactive (updates when user toggles preference). No polling needed. |
| Spring parameters for new primitives | Derived from existing `AnimationConstants` values | Codebase `AnimationConstants.swift` | `springSettle` reuses overlay spring (0.35/0.7). `gentleSpring` reuses view mode spring (0.4/0.85). `quickSettle` is a compressed variant (0.25/0.8) for micro-interactions. No new physics models. |
| Hover feedback pattern | ViewModifier | KB patterns.md (SwiftUI patterns) | Standard SwiftUI pattern for reusable view behaviors. Consistent with existing codebase conventions. |
| Stagger cap enforcement | Computed `min(index * delay, cap)` | Requirements REQ-007 (AC-007c) | Simple arithmetic; no timer or scheduler needed. Cap at 500ms means blocks beyond index 16 all animate at the same 500ms delay, creating a "wave crest" effect. |
| New file locations | `mkdn/UI/Theme/` for MotionPreference, `mkdn/UI/Components/` for visual components | KB modules.md (existing directory structure) | Follows existing module organization. Theme-related utilities go in `UI/Theme/`, visual components go in `UI/Components/`. |
| Test file locations | `mkdnTests/Unit/UI/` | Existing test directory structure | Follows `mkdnTests/Unit/{Layer}/` convention. New `UI/` subdirectory for UI-layer unit tests. |
| Popover animation strategy | Internal content animation (Approach A) | Conservative default | Preserves all system popover behavior. Lower risk than replacing `.popover()` with custom overlay. |
